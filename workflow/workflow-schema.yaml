---
# The schema for 'Workflow' YAML files.
#
# See https://json-schema.org/understanding-json-schema/index.html

$schema: http://json-schema.org/draft-07/schema#

title: Data Manager Workflow Schema
description: >-
  The Schema for Data Manager Workflows

# The root-level object -------------------------------------------------------

type: object
properties:
  kind:
    const: DataManagerWorkflow
  kind-version:
    enum:
    - '2025.2'
  name:
    $ref: '#/definitions/rfc1035-label-name'
  description:
    type: string
    description: A description of the workflow
  steps:
    type: array
    items:
      $ref: "#/definitions/step"
  variables:
    # A Job-compliant set of variable declarations for the workflow.
    # This block structure is a reproduction of that used in Job definitions
    # and, like Jobs, has no current schema so we permit anything here.
    type: object
    additionalProperties: true
required:
- kind
- kind-version
- name
- steps

# Sub-object definitions ------------------------------------------------------

definitions:

  # RFC 1035 Label Names (as used in Kubernetes)
  # See https://kubernetes.io/docs/concepts/overview/working-with-objects/names/
  rfc1035-label-name:
    type: string
    pattern: ^[a-z][a-z0-9-]{0,63}$(?<!-)
    description: >-
      A value compatible with Kubernetes variables
      to allow it to be used ins Pod Label

  # What does a Job specification template variable look like?
  # The values found in Jinja variables like '{{ x }}'.
  # Stuff like 'candidateMolecules' or 'clustered_molecules'
  variable-name:
    type: string
    pattern: ^[a-zA-Z_][a-zA-Z0-9_]*$

  # A step replication control variable
  # that is based on a step input variable
  replicate-using-input:
    type: object
    additionalProperties: false
    properties:
      input:
        $ref: '#/definitions/variable-name'
    required:
    - input

  # A Step variable
  # (whose value is derived from a variable used in a prior step)
  step-variable-from-step:
    type: object
    additionalProperties: false
    properties:
      variable:
        $ref: '#/definitions/variable-name'
      from-step:
        type: object
        additionalProperties: false
        properties:
          name:
            $ref: '#/definitions/rfc1035-label-name'
          variable:
            $ref: '#/definitions/variable-name'
        required:
        - name
        - variable
    required:
    - variable
    - from-step

  # A Step variable
  # (whose value is derived from a workflow variable)
  step-variable-from-workflow:
    type: object
    additionalProperties: false
    properties:
      variable:
        $ref: '#/definitions/variable-name'
      from-workflow-variable:
        type: object
        additionalProperties: false
        properties:
          variable:
            $ref: '#/definitions/variable-name'
        required:
        - variable
    required:
    - variable
    - from-workflow-variable

  # A step specification variable
  # (there must be at least one if a variables block is defined).
  # Typical variable syntax based on Python's definition of a variable
  # but with the inclusion of 'hyphen' within the variable.
  # The value of the variable (the object itself) is quite relaxed...
  # it simply needs to be a string, number (integer or float), or boolean.
  step-specification-variable:
    type: object
    additionalProperties: false
    patternProperties:
      '^[a-zA-Z]{1}[a-zA-Z0-9_]{0,79}$':
        oneOf:
        - type: string
        - type: integer
        - type: boolean
    minProperties: 1

  # Step specification
  step-specification:
    type: object
    additionalProperties: false
    properties:
      collection:
        type: string
      job:
        type: string
      version:
        type: string
      variables:
        $ref: "#/definitions/step-specification-variable"
    required:
    - collection
    - job
    - version

  # Steps (in a workflow)
  step:
    type: object
    additionalProperties: false
    properties:
      name:
        # A unique name for the step
        $ref: '#/definitions/rfc1035-label-name'
      description:
        # An optional description
        type: string
        description: A description of the step
      specification:
        # The step Job specififcation.
        # This MUST define `collection`, a 'job', and a 'version'.
        # 'variables' (a map of name and value)can also be provided.
        # The format of this is essentially idenical to the specification
        # used when a Job is launched via the DM API.
        $ref: '#/definitions/step-specification'
      replicate:
        # Used to indicate one input variable that is used to replicate/spawn
        # step instances based on the number of values generated for the variable.
        type: object
        additionalProperties: false
        properties:
          using:
            $ref: '#/definitions/replicate-using-input'
      variable-mapping:
        # The map of the source of the step's variables.
        # all variables the step needs (that aren;t already in the specification)
        # need to be declared here. They either come "from" a prior step
        # or are expected in th erunning workflow variables. Here we simply
        # associate every required variable to a source.
        type: array
        items:
          anyOf:
          - $ref: "#/definitions/step-variable-from-step"
          - $ref: "#/definitions/step-variable-from-workflow"
        minItems: 1
      in:
        # An optional list of the step variables that are inputs.
        # These are typically files, expected to be present in the Project directory,
        # that need to be copied (by the DM) into the step's instance directory.
        type: array
        items:
          $ref: '#/definitions/variable-name'
        minItems: 1
      out:
        # An optional list of the step variables that are outputs.
        # These are typically files, expected to be present in the Step Instance directory,
        # when it finished (successfully), that need to be copied (by the DM)
        # into the Project directory via "realise_outputs()"
        type: array
        items:
          $ref: '#/definitions/variable-name'
        minItems: 1
    required:
    - name
    - specification
